<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AR — World-Anchored (WebXR Hit-Test)</title>
  <style>
    html, body { height: 100%; margin: 0; background: #000; }
    a-scene { position: fixed !important; inset: 0 !important; }
    .hint { position: fixed; left: 0; right: 0; bottom: 0; padding: 10px 12px; color: #fff;
            background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.45) 25%);
            font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; text-align: center; }
  </style>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <!-- Componente de Hit-Test para A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-ar-hit-test-component@1.0.3/dist/aframe-ar-hit-test-component.min.js"></script>
</head>
<body>
  <a-scene
    renderer="alpha:true; antialias:true; physicallyCorrectLights:true; logarithmicDepthBuffer:true"
    xr-mode-ui="enabled: true"
    webxr="requiredFeatures: hit-test; optionalFeatures: dom-overlay,local-floor,anchors; overlayElement: #overlay"
    vr-mode-ui="enabled: false"
    embedded
  >
    <a-assets>
      <!-- Tu modelo (ideal .glb con texturas embebidas) -->
      <a-asset-item id="model" src="BCool.glb"></a-asset-item>
    </a-assets>

    <!-- Luces -->
    <a-entity light="type: ambient; intensity: 1.0"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="1 2 1"></a-entity>

    <!-- Cámara (far grande para ver a distancia si lo necesitas) -->
    <a-entity id="camera" camera="near:0.05; far:5000" look-controls="touchEnabled: true"></a-entity>

    <!-- Retículo (se alinea con la superficie detectada) -->
    <a-entity id="reticle"
              geometry="primitive: ring; radiusInner: 0.06; radiusOuter: 0.08; segmentsTheta: 32"
              material="shader: flat; opacity: 0.9"
              position="0 0 -1"
              rotation="-90 0 0"
              visible="false">
    </a-entity>

    <!-- Este entity actualiza el retículo con el hit-test -->
    <a-entity ar-hit-test="target: #reticle; type: transient"></a-entity>

    <!-- El modelo a anclar (inicia oculto hasta colocar) -->
    <a-entity id="placedRoot" visible="false">
      <a-entity id="modelEntity" gltf-model="#model"></a-entity>
    </a-entity>
  </a-scene>

  <div id="overlay" class="hint">
    Mueve el teléfono hasta ver el retículo. Toca la pantalla para colocar el objeto. Luego camina alrededor.
  </div>

  <script>
    // Ajustes de escala y orientación del modelo al colocar
    const BIG_SCALE = 1.5;  // Ajusta según tu modelo (1–3 suele ir bien)
    const FACE_CAMERA = true; // Si quieres que inicialmente mire hacia ti

    const scene = document.querySelector('a-scene');
    const reticle = document.getElementById('reticle');
    const modelRoot = document.getElementById('placedRoot');
    const modelEl = document.getElementById('modelEntity');

    // Mostrar/ocultar retículo automáticamente (el componente lo pone visible cuando hay hit)
    // Aquí sólo escuchamos taps para colocar el modelo en la pose del retículo.
    let placed = false;

    function placeAtReticle () {
      if (!reticle.getAttribute('visible')) return;
      // Copiamos posición/rotación del retículo al modelo
      const pos = reticle.object3D.position.clone();
      const rot = reticle.object3D.rotation.clone();

      modelRoot.object3D.position.copy(pos);
      modelRoot.object3D.rotation.set(0, rot.y, 0); // suele ser útil alinear Y; puedes usar rot completo si quieres
      modelEl.object3D.scale.set(BIG_SCALE, BIG_SCALE, BIG_SCALE);

      if (FACE_CAMERA) {
        // Gira el modelo hacia la cámara sólo en Y (opcional)
        const cam = scene.camera;
        if (cam) {
          const modelPos = modelRoot.object3D.getWorldPosition(new THREE.Vector3());
          const camPos = cam.getWorldPosition(new THREE.Vector3());
          const dir = camPos.clone().sub(modelPos);
          const yaw = Math.atan2(dir.x, dir.z);
          modelRoot.object3D.rotation.set(0, yaw, 0);
        }
      }

      modelRoot.setAttribute('visible', 'true');
      placed = true;

      // Opcional: ocultar el retículo después de colocar
      reticle.setAttribute('visible', 'false');
      document.getElementById('overlay').textContent = 'Objeto colocado. Muévete alrededor para verlo en 3D.';
    }

    // Tap/click para colocar
    scene.addEventListener('click', () => {
      if (!placed) placeAtReticle();
    });

    // Si quieres permitir recolocar mantén presionado 1s
    let pressTimer = null;
    scene.addEventListener('mousedown', () => {
      pressTimer = setTimeout(() => {
        placed = false;
        modelRoot.setAttribute('visible', 'false');
        document.getElementById('overlay').textContent = 'Retículo listo. Toca para recolocar el objeto.';
      }, 1000);
    });
    scene.addEventListener('mouseup', () => clearTimeout(pressTimer));
    scene.addEventListener('mouseleave', () => clearTimeout(pressTimer));
  </script>
</body>
</html>

