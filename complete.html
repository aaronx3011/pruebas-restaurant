<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GPS + AR ‚Äî Activa c√°mara si est√°s a &lt; 50 m</title>
  <style>
    :root {
      --bg: #0f172a; --panel: #111827; --muted: #94a3b8; --text: #e5e7eb;
      --accent: #10b981; --accent-2: #38bdf8; --danger: #ef4444; --warn: #f59e0b; --border: #1f2937;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 70% -10%, #0b1d34 0%, var(--bg) 45%);
      color: var(--text); display: grid; place-items: start center; padding: 24px;
    }
    .container { width: min(980px, 100%); display: grid; gap: 16px; position: relative; z-index: 2; }
    header {
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
      padding: 12px 16px; border: 1px solid var(--border); border-radius: 16px; background: linear-gradient(180deg, #0c1425 0%, #0a0f1a 100%);
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
    }
    header h1 { font-size: clamp(18px, 3.6vw, 24px); margin: 0; letter-spacing: .2px; }
    header .hint { color: var(--muted); font-size: 13px; }

    .grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 860px) { .grid { grid-template-columns: 1fr 1fr; } }

    .card { border: 1px solid var(--border); background: linear-gradient(180deg, #0a0f1b 0%, #0a0e18 100%); border-radius: 16px; padding: 16px; box-shadow: 0 8px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04); }
    .card h2 { margin: 0 0 8px; font-size: 18px; }
    .sub { color: var(--muted); font-size: 13px; margin-bottom: 12px; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

    label { font-size: 12px; color: var(--muted); margin-bottom: 6px; display: block; }

    input, select, button, textarea {
      width: 100%; border: 1px solid var(--border); background: #0b1220; color: var(--text);
      padding: 10px 12px; border-radius: 12px; font-size: 14px; outline: none;
    }
    input::placeholder { color: #6b7280; }

    button { cursor: pointer; border: 1px solid #1f2937; background: linear-gradient(180deg, #1b2a3f 0%, #132235 100%);
      transition: transform .05s ease, filter .2s ease, background .2s ease; }
    button:hover { filter: brightness(1.05); }
    button:active { transform: translateY(1px); }
    .btn-row { display: flex; gap: 10px; flex-wrap: wrap; }

    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 999px; background: #0b1220; border: 1px solid var(--border); font-size: 13px; color: var(--muted); }
    .ok { color: var(--accent); } .warn { color: var(--warn); } .err { color: var(--danger); }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 13px; color: #cbd5e1; }
    .value { display: block; padding: 8px 10px; border-radius: 10px; background: #0b1220; border: 1px solid var(--border); }

    .result { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; align-items: center; padding: 8px 10px; border-radius: 12px; background: #0b1220; border: 1px solid var(--border); }
    .result strong { font-size: 20px; }

    footer { color: var(--muted); font-size: 12px; text-align: center; margin-top: 6px; }
    .small { font-size: 12px; color: var(--muted); }
    .hr { height: 1px; background: var(--border); margin: 12px 0; border-radius: 999px; }

    /* AR overlay */
    #arOverlay { position: fixed; inset: 0; z-index: 1; display: none; }
    #arOverlay[data-active="true"] { display: block; }
    a-scene { position: fixed !important; inset: 0 !important; z-index: 1; }
    .overlay { position: fixed; inset: env(safe-area-inset-top) 0 auto 0; display: flex; justify-content: center; padding: 12px; z-index: 2; pointer-events: none; }
    .panel { pointer-events: auto; background: rgba(0,0,0,.55); color: #fff; padding: 8px 12px; border-radius: 10px; font-family: system-ui, sans-serif; font-size: 14px; display: inline-flex; gap: 10px; align-items: center; backdrop-filter: blur(6px); }
    .panel button { appearance: none; border: 1px solid rgba(255,255,255,.25); border-radius: 8px; padding: 6px 10px; background: rgba(255,255,255,.08); color: #fff; cursor: pointer; }
    .panel a { color: #6ee7ff; }
  </style>

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
</head>
<body>
  <!-- UI principal -->
  <div class="container">
    <header>
      <h1>GPS + AR ‚Äî C√°mara auto si &lt; 50 m</h1>
      <div class="hint">HTTPS/localhost + permisos de ubicaci√≥n y c√°mara.</div>
    </header>

    <div class="grid">
      <!-- Ubicaci√≥n actual -->
      <section class="card" aria-labelledby="currentLocHdr">
        <h2 id="currentLocHdr">Ubicaci√≥n actual</h2>
        <p class="sub">Usa el GPS para obtener coordenadas.</p>
        <div class="btn-row">
          <button id="btnLocate">Obtener ubicaci√≥n</button>
          <button id="btnWatch">Iniciar en vivo</button>
          <button id="btnStop" disabled>Detener</button>
        </div>
        <div class="hr"></div>
        <div class="row">
          <div><label>Latitud</label><code id="lat" class="value mono">‚Äì</code></div>
          <div><label>Longitud</label><code id="lng" class="value mono">‚Äì</code></div>
        </div>
        <div class="row">
          <div><label>Precisi√≥n (m)</label><code id="acc" class="value mono">‚Äì</code></div>
          <div><label>Timestamp</label><code id="ts" class="value mono">‚Äì</code></div>
        </div>
        <p id="geoStatus" class="pill warn" role="status">Geolocation status: idle</p>
      </section>

      <!-- Distancia -->
      <section class="card" aria-labelledby="distanceHdr">
        <h2 id="distanceHdr">Distancia y activaci√≥n de AR</h2>
        <p class="sub">Calcula distancia y rumbo A ‚Üí B. La c√°mara AR se activa autom√°ticamente si est√°s a &lt; 50 m.</p>

        <div class="btn-row" style="margin-bottom:8px">
          <button id="useCurrentForA">Usar actual ‚Üí Punto A</button>
          <button id="useCurrentForB">Usar actual ‚Üí Punto B</button>
          <button id="btnAuto">Auto-actualizar: OFF</button>
        </div>

        <div class="row">
          <div>
            <label>Punto A ‚Äî Latitud</label>
            <input id="aLat" type="number" step="any" placeholder="e.g., 10.5001" />
          </div>
          <div>
            <label>Punto A ‚Äî Longitud</label>
            <input id="aLng" type="number" step="any" placeholder="e.g., -66.9170" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Punto B ‚Äî Latitud</label>
            <input id="bLat" type="number" step="any" placeholder="e.g., 10.6417" />
          </div>
          <div>
            <label>Punto B ‚Äî Longitud</label>
            <input id="bLng" type="number" step="any" placeholder="e.g., -71.6127" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Unidades</label>
            <select id="units">
              <option value="km">Kil√≥metros</option>
              <option value="mi">Millas</option>
              <option value="m">Metros</option>
              <option value="nm">Millas n√°uticas</option>
            </select>
          </div>
          <div style="display:flex; flex-direction:column; gap:10px;">
            <button id="btnCalc">Calcular</button>
            <div class="small">La AR se activa autom√°ticamente al estar a &lt; 50 m.</div>
            <div class="small">Si iOS bloquea el inicio autom√°tico, usa el bot√≥n ‚ÄúIniciar c√°mara AR‚Äù.</div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="result" aria-live="polite">
          <div>
            <div class="small">Distancia</div>
            <strong id="outDist">‚Äì</strong>
          </div>
          <div>
            <div class="small">Rumbo (inicial)</div>
            <strong id="outBear">‚Äì</strong>
          </div>
          <div>
            <div class="small">Direcci√≥n (A ‚Üí B)</div>
            <strong id="outDir">‚Äì</strong>
          </div>
        </div>

        <div class="btn-row" style="margin-top:10px">
          <button id="btnStartARManual" style="display:none">Iniciar c√°mara AR</button>
          <button id="btnHideAR" style="display:none">Ocultar AR</button>
        </div>
      </section>
    </div>

    <footer>
      Geolocalizaci√≥n + A-Frame/AR.js. Tus coordenadas y la c√°mara quedan en tu dispositivo.
    </footer>
  </div>

  <!-- Capa AR (oculta hasta que est√© activa) -->
  <div id="arOverlay" data-active="false">
    <div class="overlay">
      <div class="panel" id="arUI">
        <span id="arStatus">AR inactiva. Se activar√° si est√°s &lt; 50 m del objetivo‚Ä¶</span>
        <button id="arFlip">Flip cam</button>
        <button id="arPlace">üìç Place</button>
        <button id="arFollow">üéØ Follow</button>
        <button id="arSnap">üì∏ Foto</button>
      </div>
    </div>

    <a-scene id="scene" embedded vr-mode-ui="enabled: false"
             renderer="alpha: true; antialias: true; precision: mediump; powerPreference: high-performance"
             arjs="sourceType: webcam; facingMode: environment; debugUIEnabled: false; videoTexture: true; trackingMethod: best;
                   sourceWidth: 1280; sourceHeight: 720; displayWidth: 1280; displayHeight: 720;">
      <a-assets>
        <!-- Reemplaza test.glb por tu modelo -->
        <a-asset-item id="model" src="test.glb"></a-asset-item>
      </a-assets>

      <a-entity light="type: ambient; intensity: 0.8"></a-entity>
      <a-entity light="type: directional; intensity: 0.8" position="1 2 1"></a-entity>

      <a-entity id="camera" camera look-controls="touchEnabled: true; mouseEnabled: false" wasd-controls="enabled:false"></a-entity>

      <!-- FOLLOW: 6 m delante de la c√°mara -->
      <a-entity id="holderFollow" position="0 0 -6">
        <a-entity id="modelFollow" gltf-model="#model" shadow="cast: true; receive: true"></a-entity>
      </a-entity>

      <!-- ANCHOR: bloqueado al mundo -->
      <a-entity id="holderAnchor" visible="false">
        <a-entity id="modelAnchor" gltf-model="#model" shadow="cast: true; receive: true"></a-entity>
      </a-entity>
    </a-scene>
  </div>

  <script>
    // ======= Utilidades y geolocalizaci√≥n =======
    const $ = (s, r=document) => r.querySelector(s);
    function fmtNum(n, digits=6){ return Number.isFinite(n) ? n.toFixed(digits).replace(/\.0+$/,'') : '‚Äì'; }
    function tsFmt(ms){ if (!ms) return '‚Äì'; const d = new Date(ms); return d.toLocaleString(); }
    function setStatus(text, mode='warn'){
      const el = $('#geoStatus'); if (!el) return;
      el.textContent = `Geolocation status: ${text}`;
      el.classList.remove('ok','warn','err'); el.classList.add(mode);
    }

    const toRad = d => d*Math.PI/180, toDeg = r => r*180/Math.PI;
    function haversine(lat1, lon1, lat2, lon2){
      const R=6371_000; const f1=toRad(lat1), f2=toRad(lat2); const dF=toRad(lat2-lat1), dL=toRad(lon2-lon1);
      const a=Math.sin(dF/2)**2 + Math.cos(f1)*Math.cos(f2)*Math.sin(dL/2)**2; return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
    function initialBearing(lat1, lon1, lat2, lon2){
      const f1=toRad(lat1), f2=toRad(lat2), l1=toRad(lon1), l2=toRad(lon2);
      const y=Math.sin(l2-l1)*Math.cos(f2); const x=Math.cos(f1)*Math.sin(f2)-Math.sin(f1)*Math.cos(f2)*Math.cos(l2-l1);
      return (Math.atan2(y,x)*180/Math.PI + 360)%360;
    }
    function convertDistance(m, unit){ return unit==='km'?m/1000: unit==='mi'?m/1609.344: unit==='nm'?m/1852: m; }
    function bearingToCardinal(b){ const d=['N','NE','E','SE','S','SW','W','NW']; return d[Math.round(b/45)%8]; }

    let watchId=null; const geoOpts={ enableHighAccuracy:true, timeout:10000, maximumAge:0 };
    function onPosSuccess(pos){
      const { latitude, longitude, accuracy } = pos.coords;
      $('#lat').textContent = fmtNum(latitude,6); $('#lng').textContent = fmtNum(longitude,6);
      $('#acc').textContent = fmtNum(accuracy,1); $('#ts').textContent = tsFmt(pos.timestamp);
      setStatus(watchId ? 'watching‚Ä¶' : 'position acquired', 'ok');
      if (auto && autoFillTarget==='B') fillCurrentInto('B');
    }
    function onPosError(err){ console.error(err); const map={1:'Permission denied',2:'Position unavailable',3:'Timeout'}; setStatus(`${map[err.code]||'Unknown error'} ‚Äî ${err.message}`,'err'); }

    $('#btnLocate').addEventListener('click', ()=>{
      if(!('geolocation' in navigator)) return setStatus('Geolocation not supported','err');
      setStatus('requesting location‚Ä¶'); navigator.geolocation.getCurrentPosition(onPosSuccess,onPosError,geoOpts);
    });
    $('#btnWatch').addEventListener('click', ()=>{
      if(!('geolocation' in navigator)) return setStatus('Geolocation not supported','err');
      if(watchId!==null) return; setStatus('starting watch‚Ä¶'); watchId = navigator.geolocation.watchPosition(onPosSuccess,onPosError,geoOpts); $('#btnStop').disabled=false;
    });
    $('#btnStop').addEventListener('click', ()=>{ if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; setStatus('watch stopped'); } $('#btnStop').disabled=true; });

    // Auto pedir permiso de notificaciones (opcional)
    if ('Notification' in window && Notification.permission === 'default') { Notification.requestPermission(); }

    // ======= Entrada / Salida de distancia =======
    function readInputs(){
      const aLat=parseFloat($('#aLat').value), aLng=parseFloat($('#aLng').value), bLat=parseFloat($('#bLat').value), bLng=parseFloat($('#bLng').value);
      if([aLat,aLng,bLat,bLng].some(v=>!Number.isFinite(v))) return null; return {aLat,aLng,bLat,bLng};
    }
    function updateOutputs(dMeters,bearingDeg){
      const unit=$('#units').value; const val=convertDistance(dMeters,unit);
      $('#outDist').textContent = `${fmtNum(val, unit==='m'?0:3)} ${unit}`;
      $('#outBear').textContent = `${fmtNum(bearingDeg,1)}¬∞`;
      $('#outDir').textContent = `${bearingToCardinal(bearingDeg)} (${fmtNum(bearingDeg,1)}¬∞)`;
    }

    let auto=false, autoFillTarget='B', alertShown=false;

    const AR_TRIGGER_METERS = 50; // *** Requisito: activar AR a < 50 m ***

    function updateDistance(isUserGesture=false){
      const vals=readInputs();
      if(!vals){ $('#outDist').textContent='‚Äì'; $('#outBear').textContent='‚Äì'; $('#outDir').textContent='‚Äì'; maybeStopAR(); return; }
      const dMeters=haversine(vals.aLat,vals.aLng,vals.bLat,vals.bLng); const brg=initialBearing(vals.aLat,vals.aLng,vals.bLat,vals.bLng); updateOutputs(dMeters,brg);

      // feedback 50 m
      if(dMeters < AR_TRIGGER_METERS){
        if(!alertShown){ alertShown=true; $('#outDist').style.color='var(--accent)'; $('#outDist').animate([{transform:'scale(1.1)'},{transform:'scale(1)'}],{duration:600,iterations:3}); if('Notification' in window && Notification.permission==='granted'){ new Notification('Est√°s a < 50 m: AR activ√°ndose‚Ä¶'); } }
        ensureARActive(/*auto*/ !isUserGesture);
      } else {
        alertShown=false; $('#outDist').style.color='inherit'; maybeStopAR();
      }
    }

    $('#btnCalc').addEventListener('click', ()=>updateDistance(true));
    $('#units').addEventListener('change', ()=>updateDistance(false));
    ;['#aLat','#aLng','#bLat','#bLng'].forEach(sel=>$(sel).addEventListener('input', ()=>{ if(auto) updateDistance(false); }));
    $('#btnAuto').addEventListener('click', ()=>{ auto=!auto; $('#btnAuto').textContent = auto ? 'Auto-actualizar: ON' : 'Auto-actualizar: OFF'; if(auto) updateDistance(false); });

    function fillCurrentInto(target){
      const lat=parseFloat($('#lat').textContent), lng=parseFloat($('#lng').textContent);
      if(!Number.isFinite(lat)||!Number.isFinite(lng)) return setStatus('Primero obt√©n tu ubicaci√≥n','warn');
      if(target==='A'){ $('#aLat').value=lat; $('#aLng').value=lng; }
      if(target==='B'){ $('#bLat').value=lat; $('#bLng').value=lng; }
      updateDistance(false);
    }
    $('#useCurrentForA').addEventListener('click', ()=>fillCurrentInto('A'));
    $('#useCurrentForB').addEventListener('click', ()=>fillCurrentInto('B'));

    // Hint HTTPS
    (function(){ const isHttps=location.protocol==='https:'||['localhost','127.0.0.1'].includes(location.hostname); if(!isHttps) setStatus('Usa HTTPS o localhost para precisi√≥n','warn'); else setStatus('ready','ok'); })();

    // ======= AR (A-Frame + AR.js) =======
    const sceneEl = document.getElementById('scene');
    const camEl = document.getElementById('camera');
    const holderFollow = document.getElementById('holderFollow');
    const modelFollow  = document.getElementById('modelFollow');
    const holderAnchor = document.getElementById('holderAnchor');
    const modelAnchor  = document.getElementById('modelAnchor');

    const arStatus = document.getElementById('arStatus');
    const arOverlay = document.getElementById('arOverlay');
    const btnStartARManual = document.getElementById('btnStartARManual');
    const btnHideAR = document.getElementById('btnHideAR');

    const arFlipBtn = document.getElementById('arFlip');
    const arPlaceBtn= document.getElementById('arPlace');
    const arFollowBtn=document.getElementById('arFollow');
    const arSnapBtn = document.getElementById('arSnap');

    const FIXED_DIST=6.0, FIXED_SCALE=0.05, FIXED_HEIGHT=0.0, FIXED_ROT_Y=0.0;

    function applyFixedXforms(target){
      target.object3D.position.set(0, FIXED_HEIGHT, 0);
      target.object3D.rotation.set(0, THREE.MathUtils.degToRad(FIXED_ROT_Y), 0);
      target.object3D.scale.set(FIXED_SCALE, FIXED_SCALE, FIXED_SCALE);
    }
    function placeFollowDistance(){ holderFollow.object3D.position.set(0,0,-FIXED_DIST); }
    placeFollowDistance(); applyFixedXforms(modelFollow); applyFixedXforms(modelAnchor);

    let mode='FOLLOW';
    function setMode(m){ mode=m; const follow=(m==='FOLLOW'); holderFollow.setAttribute('visible',follow); holderAnchor.setAttribute('visible',!follow); if(follow) placeFollowDistance(); }
    setMode('FOLLOW');

    function worldLockPlace(){
      const camObj = camEl.object3D; camObj.updateMatrixWorld();
      const camPos=new THREE.Vector3(), camQuat=new THREE.Quaternion(), camScale=new THREE.Vector3();
      camObj.matrixWorld.decompose(camPos,camQuat,camScale);
      const forward=new THREE.Vector3(0,0,-1).applyQuaternion(camQuat);
      const targetPos=camPos.clone().add(forward.multiplyScalar(FIXED_DIST));
      holderAnchor.object3D.position.copy(targetPos);
      const euler=new THREE.Euler().setFromQuaternion(camQuat,'YXZ'); holderAnchor.object3D.rotation.set(0,euler.y,0);
      setMode('ANCHOR'); applyFixedXforms(modelAnchor);
    }

    arPlaceBtn.addEventListener('click', worldLockPlace);
    arFollowBtn.addEventListener('click', ()=>{ setMode('FOLLOW'); applyFixedXforms(modelFollow); placeFollowDistance(); });

    arSnapBtn.addEventListener('click', ()=>{ const r=sceneEl.renderer; if(!r) return alert('Renderer not ready'); r.preserveDrawingBuffer=true; const url=r.domElement.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download='ar-photo.png'; a.click(); r.preserveDrawingBuffer=false; });

    let usingFront=false;
    async function flipCamera(){ const sys=sceneEl.systems && sceneEl.systems['arjs']; if(!sys||!sys.arSource) return; try{ usingFront=!usingFront; await sys.arSource.stop(); sys.arSource.parameters.facingMode = usingFront ? 'user' : 'environment'; await sys.arSource.start(); setARStatus('C√°mara: '+(usingFront?'frontal':'trasera')); }catch(e){ setARStatus('Flip failed: '+e.message); } }
    arFlipBtn.addEventListener('click', flipCamera);

    function setARStatus(msg){ arStatus.textContent = msg; }

    let arActive=false; let arEverStarted=false; let arStarting=false;

    async function startARCore(){
      const sys=sceneEl.systems && sceneEl.systems['arjs']; if(!sys||!sys.arSource) return false;
      if(sys.arSource.ready===false){ await sys.arSource.start(); }
      // iOS gyro permission
      if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
        try{ await DeviceOrientationEvent.requestPermission(); }catch(_){}
      }
      return true;
    }

    async function ensureARActive(autoAttempt=true){
      if(arActive || arStarting) return;
      arStarting=true;
      try{
        // Mostrar capa AR
        arOverlay.setAttribute('data-active','true'); btnHideAR.style.display='inline-block';
        // Intento autom√°tico
        if(autoAttempt){
          try{
            const ok = await startARCore();
            if(ok){ arActive=true; arEverStarted=true; setARStatus('AR activa'); btnStartARManual.style.display='none'; return; }
          }catch(e){ /* cae a manual */ }
        }
        // Manual necesario
        btnStartARManual.style.display='inline-block'; setARStatus('Toca ‚ÄúIniciar c√°mara AR‚Äù (iOS necesita gesto)');
      } finally { arStarting=false; }
    }

    async function stopARCore(){ const sys=sceneEl.systems && sceneEl.systems['arjs']; if(sys && sys.arSource){ try{ await sys.arSource.stop(); }catch(_){} } }

    async function maybeStopAR(){ if(!arActive && !arEverStarted){ arOverlay.setAttribute('data-active','false'); btnHideAR.style.display='none'; btnStartARManual.style.display='none'; setARStatus('AR inactiva.'); return; }
      // Si ya estaba activa y te alejas, apaga c√°mara pero deja overlay oculto
      if(arActive){ await stopARCore(); arActive=false; setARStatus('Fuera de rango (‚â• 50 m). AR detenida.'); }
      arOverlay.setAttribute('data-active','false'); btnHideAR.style.display='none'; btnStartARManual.style.display='none';
    }

    btnStartARManual.addEventListener('click', async ()=>{
      try{ const ok = await startARCore(); if(ok){ arActive=true; arEverStarted=true; setARStatus('AR activa'); btnStartARManual.style.display='none'; } }
      catch(e){ setARStatus('No se pudo iniciar: '+e.message); }
    });

    btnHideAR.addEventListener('click', async ()=>{ await maybeStopAR(); });

    document.addEventListener('visibilitychange', ()=>{
      const sys=sceneEl.systems && sceneEl.systems['arjs']; if(!sys||!sys.arSource) return;
      if(!document.hidden){ const video=sys.arSource.domElement; if(video && (video.paused || video.readyState<2)){ sys.arSource.start().then(()=> setARStatus('Reanudada tras volver a la pesta√±a')); } }
    });
  </script>
</body>
</html>

