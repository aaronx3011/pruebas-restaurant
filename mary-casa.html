<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Brújula hacia Punto (Ángulo + Distancia)</title>
  <style>
    :root{
      --bg:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --accent:#38bdf8; --accent-2:#10b981; --disabled:#334155; --warn:#f59e0b;
    }
    *{ box-sizing:border-box }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif }
    .wrap{ min-height:100%; display:grid; place-items:center; padding:16px }
    .col{ display:flex; flex-direction:column; align-items:center; gap:18px }
    .arrow-wrap{ width:200px; height:200px; display:grid; place-items:center; transition:transform .08s linear }
    .arrow{ width:160px; height:160px; display:block }
    .deg{ font-size:40px; line-height:1; font-variant-numeric:tabular-nums }
    .unit{ color:var(--muted); margin-left:6px }
    .readout{ display:flex; align-items:baseline }
    .tap{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:14px; background:rgba(15,23,42,.4); backdrop-filter: blur(4px); }
    .hidden{ display:none }

    .btn{
      appearance:none; border:0; cursor:pointer;
      padding:12px 18px; border-radius:12px; font-size:16px; font-weight:600;
      background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:#00131a;
      box-shadow: 0 8px 24px rgba(16,185,129,.25);
      transition: transform .08s ease, filter .2s ease, opacity .2s ease;
    }
    .btn:active{ transform: translateY(1px) }
    .btn[disabled]{ background: var(--disabled); color:#94a3b8; cursor:not-allowed; box-shadow:none; filter:saturate(.6); opacity:.6; }

    .status{ font-size:12px; color:var(--muted); text-align:center; max-width:320px }
    .status b{ color:var(--text) }

    .debug{
      display:none; font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size:12px; color:#cbd5e1; background:#0b1220; border:1px solid #1f2937;
      padding:10px; border-radius:10px; width:min(92vw, 420px);
      box-shadow:0 8px 24px rgba(0,0,0,.35);
    }
    .debug.show{ display:block }
    .warn{ color:var(--warn) }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="col">
      <div id="arrowWrap" class="arrow-wrap" aria-label="Flecha a ángulo" role="img" title="Flecha a ángulo">
        <svg class="arrow" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <filter id="soft" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur in="SourceAlpha" stdDeviation="2" result="blur"/>
              <feOffset in="blur" dx="0" dy="2" result="off"/>
              <feMerge><feMergeNode in="off"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
          </defs>
          <polygon filter="url(#soft)" points="50,6 84,76 50,62 16,76" fill="#38bdf8"/>
          <circle cx="50" cy="76" r="4" fill="#e5e7eb"/>
        </svg>
      </div>

      <!-- Ángulo -->
      <div class="readout"><div id="deg" class="deg">—</div><div class="unit">°</div></div>
      <!-- Distancia -->
      <div class="readout"><div id="meters" class="deg" style="font-size:32px">—</div><div class="unit">m</div></div>

      <!-- Botón condicional (<100 m) -->
      <button id="goBtn" class="btn" disabled>Buzz</button>

      <!-- Estado / ayuda -->
      <div id="status" class="status">Permite movimiento y ubicación. Mantén el teléfono <b>vertical</b> mirando al destino.</div>

      <!-- Debug (toque prolongado para alternar) -->
      <div id="debug" class="debug"></div>
    </div>
  </div>

  <!-- Overlay para pedir permisos en iOS -->
  <div id="tapHint" class="tap hidden">
    <div style="display:flex; flex-direction:column; gap:10px; align-items:center;">
      <div>Para activar la brújula en iPhone/iPad toca “Activar”.</div>
      <button id="activateBtn" class="btn">Activar</button>
      <div style="font-size:12px; color:#cbd5e1;">Tip: usa HTTPS para mejor precisión.</div>
    </div>
  </div>

  <script>
  (function(){
    // ================= CONFIG =================
    const A_LAT = 25.845152;
    const A_LNG = -80.368469;
    const DECLINATION_OFFSET = 0;

    // ================= UTILIDADES =================
    // Detección robusta de iOS/iPadOS (incluye iPad "como Mac")
    const isiOSFamily =
      /iPad|iPhone|iPod/.test(navigator.userAgent) ||
      (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

    // ¿Requiere permisos explícitos? (iOS 13+)
    const needsPermission =
      (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') ||
      (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function');

    const arrowWrap = document.getElementById('arrowWrap');
    const degEl = document.getElementById('deg');
    const metersEl = document.getElementById('meters');
    const goBtn = document.getElementById('goBtn');
    const statusEl = document.getElementById('status');
    const debugEl = document.getElementById('debug');
    const tapHint = document.getElementById('tapHint');
    const activateBtn = document.getElementById('activateBtn');

    const toRad = (d)=> d * Math.PI / 180;
    const toDeg = (r)=> r * 180 / Math.PI;
    const normalize = (d)=> { d = d % 360; return d < 0 ? d + 360 : d; };

    function screenAngle(){
      if (screen.orientation && typeof screen.orientation.angle === 'number') return screen.orientation.angle;
      if (typeof window.orientation === 'number') return (window.orientation + 360) % 360;
      return 0;
    }

    function distanceMeters(lat1, lon1, lat2, lon2){
      const R = 6371000; // m
      const dφ = toRad(lat2 - lat1);
      const dλ = toRad(lon2 - lon1);
      const φ1 = toRad(lat1);
      const φ2 = toRad(lat2);
      const a = Math.sin(dφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function initialBearing(lat1, lon1, lat2, lon2){
      const φ1 = toRad(lat1), φ2 = toRad(lat2);
      const Δλ = toRad(lon2 - lon1);
      const y = Math.sin(Δλ) * Math.cos(φ2);
      const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
      return normalize(toDeg(Math.atan2(y, x)));
    }

    // Suavizado circular (EMA)
    let emaHeading = null; const SMOOTH = 0.15;
    function smoothHeading(value){
      if (value == null) return emaHeading;
      if (emaHeading == null){ emaHeading = value; return value; }
      const delta = (((value - emaHeading) + 540) % 360) - 180;
      emaHeading = (emaHeading + SMOOTH * delta + 360) % 360;
      return emaHeading;
    }

    // Continuidad visual
    let lastVisual = null, cumVisual = 0;
    function renderArrow(absAngle0to360){
      if (lastVisual === null){
        lastVisual = absAngle0to360;
        cumVisual = absAngle0to360;
        arrowWrap.style.transform = `rotate(${cumVisual}deg)`;
        return;
      }
      const delta = (((absAngle0to360 - lastVisual) + 540) % 360) - 180;
      cumVisual += delta;
      lastVisual = absAngle0to360;
      arrowWrap.style.transform = `rotate(${cumVisual}deg)`;
    }

    // ================= ESTADO =================
    let deviceHeading = null;
    let targetBearing = null;
    let lastFix = { lat:null, lng:null, dist:null };
    let headingSource = 'idle';

    function setStatus(msg){ statusEl.innerHTML = msg; }

    function updateButton(distanceM){
      const canGo = Number.isFinite(distanceM) && distanceM < 50;
      goBtn.disabled = !canGo;
    }

    function updateDebug(e){
      const ang = screenAngle();
      const lines = [
        `src: ${headingSource}`,
        `targetBearing: ${targetBearing!=null? targetBearing.toFixed(1):'—'}°`,
        `deviceHeading: ${deviceHeading!=null? deviceHeading.toFixed(1):'—'}°`,
        `relative: ${(targetBearing!=null&&deviceHeading!=null)? normalize(targetBearing-deviceHeading).toFixed(1):'—'}°`,
        `alpha: ${typeof e?.alpha==='number'? e.alpha.toFixed(1):'—'}`,
        `beta: ${typeof e?.beta==='number'? e.beta.toFixed(1):'—'}`,
        `gamma: ${typeof e?.gamma==='number'? e.gamma.toFixed(1):'—'}`,
        `screenAngle: ${ang}°`,
        `declinationOffset: ${DECLINATION_OFFSET}°`,
        `dist: ${lastFix.dist!=null? Math.round(lastFix.dist):'—'} m`,
        `lat,lng: ${lastFix.lat!=null? lastFix.lat.toFixed(6):'—'}, ${lastFix.lng!=null? lastFix.lng.toFixed(6):'—'}`
      ];
      debugEl.textContent = lines.join('\n');
    }

    // ================= GEO =================
    const geoOpts = { enableHighAccuracy:true, timeout:10000, maximumAge:0 };
    (function startGeo(){
      const isHttps = location.protocol === 'https:' || ['localhost','127.0.0.1'].includes(location.hostname);
      if (!('geolocation' in navigator)) { console.warn('Sin geolocalización'); setStatus('Tu navegador no soporta geolocalización'); return; }
      if (!isHttps) console.warn('Usa HTTPS o localhost para mayor precisión');
      navigator.geolocation.watchPosition(onPosSuccess, onPosError, geoOpts);
    })();

    function onPosSuccess(pos){
      const { latitude, longitude, accuracy } = pos.coords;
      lastFix.lat = latitude; lastFix.lng = longitude;

      targetBearing = initialBearing(latitude, longitude, A_LAT, A_LNG);

      const dist = distanceMeters(latitude, longitude, A_LAT, A_LNG);
      lastFix.dist = dist;
      metersEl.textContent = Math.round(dist);
      updateButton(dist);

      degEl.textContent = targetBearing != null ? Math.round(targetBearing) : '—';

      if (typeof accuracy === 'number' && accuracy > 50){
        setStatus(`Precisión GPS baja (~${Math.round(accuracy)} m). Muévete o espera mejor señal.`);
      } else {
        setStatus('Mantén el teléfono vertical y apunta hacia el destino.');
      }

      updateArrow();
    }

    function onPosError(err){
      console.warn('Geoloc error:', err);
      targetBearing = null;
      metersEl.textContent = '—';
      updateButton(Infinity);
      setStatus('No se pudo obtener tu ubicación.');
    }

    // ================= HEADING =================
    function postureAdjust(h, e){
      const beta = typeof e?.beta === 'number' ? e.beta : 0;
      const ang = screenAngle();
      const upright = Math.abs(beta) >= 30;
      if (!upright) return h;
      if (ang === 0 || ang === 180) return normalize(h + 90);
      return h;
    }

    function computeHeadingFromEvent(e){
      if (typeof e.webkitCompassHeading === 'number'){
        headingSource = 'webkit';
        return normalize(e.webkitCompassHeading + DECLINATION_OFFSET);
      }
      if (e.absolute === true && typeof e.alpha === 'number'){
        headingSource = 'absolute';
        let hdg = 360 - e.alpha;
        hdg = normalize(hdg + screenAngle());
        hdg = postureAdjust(hdg, e);
        return hdg;
      }
      if (typeof e.alpha === 'number'){
        headingSource = 'alpha';
        let hdg = 360 - e.alpha;
        hdg = normalize(hdg + screenAngle());
        hdg = postureAdjust(hdg, e);
        return hdg;
      }
      headingSource = 'none';
      return null;
    }

    function onOrientation(e){
      const h = computeHeadingFromEvent(e);
      if (typeof h === 'number'){
        deviceHeading = smoothHeading(h);
        updateArrow();
      }
      if (typeof e.webkitCompassAccuracy === 'number'){
        if (e.webkitCompassAccuracy > 20){
          setStatus('Precisión de brújula baja. Mueve el teléfono en forma de 8 para calibrar.');
        }
      }
      updateDebug(e);
    }

    function updateArrow(){
      if (targetBearing == null || deviceHeading == null) return;
      const relative = normalize(targetBearing - deviceHeading);
      renderArrow(relative);
    }

    // ================= PERMISOS / INICIO =================
    function startHeading(){
      const useAbs = 'ondeviceorientationabsolute' in window;
      window.addEventListener(useAbs ? 'deviceorientationabsolute' : 'deviceorientation', onOrientation, { passive:true });
    }

    async function requestAllPermissions(){
      let granted = true;
      if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
        try {
          const res = await DeviceMotionEvent.requestPermission();
          granted = granted && (res === 'granted');
        } catch(e){ granted = false; }
      }
      if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function'){
        try {
          const res = await DeviceOrientationEvent.requestPermission();
          granted = granted && (res === 'granted');
        } catch(e){ granted = false; }
      }
      return granted;
    }

    async function armIOSIfNeeded(){
      // Si se requiere permiso (iOS 13+), mostramos overlay y pedimos con botón
      if (needsPermission){
        tapHint.classList.remove('hidden');
        activateBtn.addEventListener('click', async ()=>{
          const ok = await requestAllPermissions();
          if (ok){
            startHeading();
            tapHint.classList.add('hidden');
          } else {
            tapHint.querySelector('div').firstChild.textContent = 'Permiso denegado. Ve a Configuración > Safari para permitir Movimiento/Orientación.';
          }
        }, { once:true });
      } else {
        // No requiere permiso explícito; empezamos de una vez
        startHeading();
      }
    }

    armIOSIfNeeded();

    (screen.orientation || window).addEventListener?.('change', ()=>{
      emaHeading = null;
      lastVisual = null;
    });

    // Botón
    goBtn.addEventListener('click', ()=>{
      if (goBtn.disabled) return;
      window.location.href = 'https://aaronx3011.github.io/pruebas-restaurant/bbee3';
    });

    // Debug: toque prolongado para alternar panel
    let pressTimer=null;
    window.addEventListener('pointerdown', ()=>{
      clearTimeout(pressTimer);
      pressTimer = setTimeout(()=> debugEl.classList.toggle('show'), 1200);
    });
    window.addEventListener('pointerup', ()=> clearTimeout(pressTimer));
  })();
  </script>
</body>
</html>

