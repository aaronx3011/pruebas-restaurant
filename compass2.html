<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Phone Compass (Web)</title>
  <style>
:root {
  --bg: #0f172a;        /* slate-900 */
  --card: #111827;      /* gray-900 */
  --text: #e5e7eb;      /* gray-200 */
  --muted: #94a3b8;     /* slate-400 */
  --accent: #38bdf8;    /* sky-400 */
  --ring: #1f2937;      /* gray-800 */
}
* { box-sizing: border-box; }
html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
.wrap { min-height: 100%; display: grid; place-items: center; padding: 16px; }
.card { width: 100%; max-width: 420px; background: var(--card); border: 1px solid var(--ring); border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
.title { font-size: 18px; font-weight: 600; margin: 0 0 12px; }
.sub { font-size: 13px; color: var(--muted); margin-bottom: 14px; }
.compass-box { display: grid; place-items: center; margin: 16px 0; }
.dial {
  width: 260px; height: 260px; border-radius: 50%;
  border: 10px solid var(--ring);
  display: grid; place-items: center;
  position: relative; background: radial-gradient(ellipse at center, #0b1220 0%, #0b1220 70%, #060a12 100%);
  box-shadow: inset 0 0 40px rgba(0,0,0,.5);
  transition: transform .08s linear;
}
.ticks { position: absolute; inset: 14px; }
.tick { position: absolute; left: 50%; top: 50%; width: 2px; height: 12px; background: #334155; transform-origin: 0  -104px; }
.label { position: absolute; left: 50%; top: 50%; transform: translate(-50%,-118px); font-size: 14px; color: var(--muted); }
.north { position: absolute; left: 50%; top: 50%; transform: translate(-50%,-120px); font-weight: 700; color: var(--accent); }
.needle {
  position: absolute; width: 4px; height: 100px; background: #e11d48;  /* red */
  top: 30px; left: 50%; transform: translateX(-50%);
  border-radius: 2px;
  box-shadow: 0 0 12px rgba(225,29,72,.5);
}
.pivot {
  position: absolute; width: 12px; height: 12px; border-radius: 50%;
  background: #e5e7eb; box-shadow: 0 0 10px rgba(255,255,255,.3);
}
.readout { display: flex; align-items: baseline; gap: 6px; justify-content: center; margin-top: 10px; }
.deg { font-size: 36px; font-variant-numeric: tabular-nums; }
.unit { color: var(--muted); }
.actions { display: grid; gap: 10px; margin-top: 16px; }
button {
  appearance: none; border: 1px solid var(--ring); background: #0b1324; color: var(--text);
  padding: 10px 12px; border-radius: 10px; cursor: pointer; font-weight: 600;
}
.hint { font-size: 12px; color: var(--muted); margin-top: 10px; line-height: 1.35; }
.ok { color: #22c55e; }
.warn { color: #f59e0b; }
.err { color: #ef4444; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 class="title">Compass</h1>
      <p class="sub">Tap “Enable compass” on iOS (requires HTTPS). On Android, it should start automatically.</p>

      <div class="compass-box">
        <div class="dial" id="dial">
          <div class="ticks"><!-- ticks generated by JS --></div>
          <div class="needle"></div>
          <div class="pivot"></div>
          <div class="north">N</div>
        </div>
        <div class="readout">
          <div class="deg" id="deg">—</div><div class="unit">°</div>
        </div>
      </div>

      <div class="actions">
        <button id="enableBtn">Enable compass</button>
        <button id="calibrateNorthBtn" title="Point the phone’s TOP to real north, then tap">Calibrate (point to North)</button>
        <button id="calibBtn" title="If the heading drifts">Calibration tips</button>
      </div>

      <div class="hint" id="status">Status: <span class="warn">waiting for sensor…</span></div>
      <div class="hint">Troubleshooting: be on HTTPS, allow motion/gyro permissions, avoid strong magnets, and keep the phone flat/upright consistently while testing.</div>
    </div>
  </div>

  <script>
(function() {
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  const dial = document.getElementById('dial');
  const degEl = document.getElementById('deg');
  const statusEl = document.getElementById('status');
  const enableBtn = document.getElementById('enableBtn');
  const calibBtn = document.getElementById('calibBtn');
  const calibrateNorthBtn = document.getElementById('calibrateNorthBtn');

  // Build ticks/labels every 30°
  const ticksHost = dial.querySelector('.ticks');
  ticksHost.innerHTML = '';
  for (let i = 0; i < 360; i += 30) {
    const t = document.createElement('div');
    t.className = 'tick';
    t.style.transform = `translate(-1px,-1px) rotate(${i}deg) translate(0,-104px)`;
    ticksHost.appendChild(t);

    if (i !== 0) {
      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = i;
      const upright = document.createElement('div');
      upright.style.position = 'absolute';
      upright.style.left = '50%';
      upright.style.top = '50%';
      upright.style.transform = `translate(-50%,-50%) rotate(${i}deg)`;
      const text = label.cloneNode(true);
      text.style.transform = `translate(-50%,-118px) rotate(${-i}deg)`;
      upright.appendChild(text);
      ticksHost.appendChild(upright);
    }
  }

  // Utilities
  function screenAngle() {
    if (screen.orientation && typeof screen.orientation.angle === 'number') return screen.orientation.angle;
    if (typeof window.orientation === 'number') return (window.orientation + 360) % 360; // iOS legacy
    return 0;
  }
  function normalize(d) {
    d = d % 360; return d < 0 ? d + 360 : d;
  }
  function setStatus(ok, msg, cls='') {
    statusEl.innerHTML = `Status: <span class="${cls || (ok ? 'ok' : 'warn')}">${msg}</span>`;
  }

  // Circular EMA smoothing (prevents jitter and 359→0 wrap jumps)
  let ema = null; const SMOOTH = 0.15;
  function smoothHeading(value) {
    if (value == null) return ema;
    if (ema == null) { ema = value; return value; }
    const delta = (((value - ema) + 540) % 360) - 180; // shortest path on circle
    ema = (ema + SMOOTH * delta + 360) % 360;
    return ema;
  }

  // User calibration offset: added to computed heading
  let userOffset = 0;
  function applyUserOffset(h) { return normalize(h + userOffset); }

  // Heuristic posture adjustment:
  // If phone is fairly upright in PORTRAIT (|beta| >= 30), add +90° so the top edge points to north.
  function postureAdjust(h, e) {
    const beta = typeof e.beta === 'number' ? e.beta : 0; // front/back tilt
    const ang = screenAngle(); // 0/90/180/270
    const upright = Math.abs(beta) >= 30;
    if (!upright) return h; // flat-on-table → alpha path already correct
    if (ang === 0 || ang === 180) { // portrait orientations
      return normalize(h + 90);
    }
    return h; // landscape handled by screenAngle compensation
  }

  // Compute heading from an orientation event
  function computeHeadingFromEvent(e) {
    // iOS Safari provides a compass heading directly (clockwise from North)
    if (typeof e.webkitCompassHeading === 'number') {
      return normalize(e.webkitCompassHeading);
    }
    // General path: use alpha (z-rotation, 0..360), convert to compass convention,
    // compensate for screen rotation and posture.
    if (typeof e.alpha === 'number') {
      let hdg = 360 - e.alpha;              // convert to clockwise-from-north
      hdg = normalize(hdg + screenAngle()); // compensate for portrait/landscape
      hdg = postureAdjust(hdg, e);          // adjust if the device is upright in portrait
      return hdg;
    }
    return null;
  }

  function updateUI(heading) {
    const s = smoothHeading(heading);
    if (typeof s === 'number') {
      dial.style.transform = `rotate(${-s}deg)`; // Rotate dial opposite so "N" points north
      degEl.textContent = Math.round(s);
    }
  }

  let listening = false;
  let usingAbsolute = false;

  function startListening() {
    if (listening) return;
    // Prefer absolute orientation if available
    const hasAbsolute = 'ondeviceorientationabsolute' in window;
    if (hasAbsolute) {
      window.addEventListener('deviceorientationabsolute', onOrientation, { passive: true });
      usingAbsolute = true;
      setStatus(true, 'using absolute orientation…');
    } else {
      window.addEventListener('deviceorientation', onOrientation, { passive: true });
      usingAbsolute = false;
      setStatus(true, 'listening for heading…');
    }
    listening = true;
  }

  function onOrientation(e) {
    const heading = computeHeadingFromEvent(e);
    if (typeof heading === 'number' && !Number.isNaN(heading)) {
      updateUI(applyUserOffset(heading));
    }
  }

  // iOS permission flow (requires HTTPS + user gesture)
  async function requestIOSPermissionIfNeeded() {
    if (!isIOS) return true;
    const fn = window.DeviceOrientationEvent && DeviceOrientationEvent.requestPermission;
    if (typeof fn === 'function') {
      try {
        const state = await DeviceOrientationEvent.requestPermission();
        if (state === 'granted') return true;
        setStatus(false, 'motion permission denied', 'err');
        return false;
      } catch {
        setStatus(false, 'motion permission error', 'err');
        return false;
      }
    }
    return true; // older iOS
  }

  // UI handlers
  enableBtn.addEventListener('click', async () => {
    const ok = await requestIOSPermissionIfNeeded();
    if (ok) startListening();
  });

  calibBtn.addEventListener('click', () => {
    alert([
      'Calibration tips:',
      '• Move away from magnets/metal (cases, speakers, cars).',
      '• Make a slow “figure-8” with your phone.',
      '• Ensure motion permissions are allowed.',
      '• Keep one posture (flat or upright) while testing.',
    ].join('\n'));
  });

  // One-tap user offset: point phone’s TOP to real north, then tap.
  calibrateNorthBtn.addEventListener('click', () => {
    const current = Number(degEl.textContent);
    if (Number.isFinite(current)) {
      userOffset = normalize(0 - current);
      setStatus(true, `calibrated offset: ${userOffset.toFixed(0)}°`);
    } else {
      setStatus(false, 'no heading yet to calibrate', 'warn');
    }
  });

  // Auto-start on Android (no permission prompt)
  if (!isIOS) startListening();

  // Reset smoothing on orientation changes to avoid jumps
  (screen.orientation || window).addEventListener?.('change', () => { ema = null; });
})();
  </script>
</body>
</html>

